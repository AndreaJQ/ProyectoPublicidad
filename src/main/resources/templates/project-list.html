<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="fragments/layout :: _head"></head>


<body>
<header th:replace="fragments/layout :: _header"></header>

<main class="main-gris">
  <div th:replace="fragments/layout :: nav-server"></div>
  <div class="container">
    <div class="d-flex fles-row justify-content-between align-items-center">
      <h1>Lista de Proyectos</h1>
      <a class="btn btn-outline-success" th:href="@{/user/perfil}" type="button">Volver</a>
    </div>

  <table class="table">
    <thead>
        <tr>
          <th onclick="sortTable(0)" class="desc">ID</th>
          <th onclick="sortTable(1)" class="desc">TITULO</th>
          <th onclick="sortTable(3)" class="desc">PROPIETARIO</th>
          <th onclick="sortTable(2)" class="desc">CREACIÓN</th>
          <th onclick="sortTable(2)" class="desc">DEADLINE</th>
          <th onclick="sortTable(3)" class="desc">COLAB</th>
          <th onclick="sortTable(5)" class="desc ">ESTADO</th>
          <th onclick="sortTable(3)" class="desc">TIPO</th>
          <th>ARCHIVO</th>
          <th>ABRIR</th>
          <th>PROYECTO</th>
          <th>ELIMINAR</th>
          </tr>
      </thead>
      <tbody th:each="proyecto : ${proyecto}">

      <th scope="row" th:text="${proyecto.id}"></th>
      <td th:text="${proyecto.nombre}"></td>
      <td th:text="${proyecto.propietario.name}"></td>
      <td th:text="${proyecto.fecha}"></td>
      <td th:text="${proyecto.fechaLimite}"></td>
      <td>
        <ul>
          <li th:each="colaborador : ${proyecto.colaborador}" th:text="${colaborador.name}"></li>
        </ul>
      </td>
      <td th:if="${proyecto.altaBaja}">ALTA</td>
      <td th:unless="${proyecto.altaBaja}"> BAJA</td>
      <td th:text="${proyecto.visibilidad}"></td>
      <td>
        <span th:if="${proyecto.archivo != null}">
      <a th:href="@{/archivo/load/{archivoId}(archivoId=${proyecto.archivo.id})}" class="btn btn-outline-primary">Descargar</a>
    </span>
        <span th:unless="${proyecto.archivo != null}">No hay archivo</span>
      </td>

          <td><a th:href= "@{/proyecto/{pId} (pId=${proyecto.id})}" class="btn btn-outline-info"> VER </a> </td>
        <td><a th:href= "@{/admin/status/{id} (id=${proyecto.id})}" class="btn btn-outline-info"> ALTA/BAJA </a>
          <td><a th:href= "@{/admin/deleteProject/{id} (id=${proyecto.id})}" class="btn btn-outline-danger"> ELIMINAR </a> </td>
      </tr>

      </tbody>
    </table>
  </div>
</main>
<footer th:replace="fragments/layout :: _footer"></footer>
<div th:replace="fragments/layout :: _script"></div>
<script>
    // Variables para mantener el estado de ordenamiento
    const sortStates = [null, null, null, null, null, null, null, null, null, null];

    // Función para obtener el contenido de texto de un elemento (ignorando etiquetas HTML)
    function getTextContent(element) {
      return element.textContent || element.innerText;
    }

    // Función para cambiar el estado de ordenamiento
    function toggleSortState(columnIndex) {
      if (sortStates[columnIndex] === "asc") {
        sortStates[columnIndex] = "desc";
      } else {
        sortStates[columnIndex] = "asc";
      }
    }

    // Función para obtener el estado de ordenamiento
    function getSortState(columnIndex) {
      return sortStates[columnIndex];
    }

    // Función para ordenar la tabla por la columna indicada
    function sortTable(columnIndex) {
      let table, rows, switching, i, x, y, shouldSwitch;
      table = document.querySelector(".table");  // Cambia el selector para obtener la tabla
      switching = true;

      while (switching) {
        switching = false;
        rows = table.rows;

        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName("TD")[columnIndex];
          y = rows[i + 1].getElementsByTagName("TD")[columnIndex];

          // Obtén el contenido de texto de las celdas (ignorando enlaces)
          const xText = getTextContent(x);
          const yText = getTextContent(y);

          // Compara los valores según el tipo de columna (numérico o alfanumérico)
          if (columnIndex === 0 || columnIndex === 3 || columnIndex === 5) {
            if ((getSortState(columnIndex) === "asc" && Number(xText) > Number(yText)) ||
                (getSortState(columnIndex) === "desc" && Number(xText) < Number(yText))) {
              shouldSwitch = true;
              break;
            }
          } else {
            if ((getSortState(columnIndex) === "asc" && xText.toLowerCase() > yText.toLowerCase()) ||
                (getSortState(columnIndex) === "desc" && xText.toLowerCase() < yText.toLowerCase())) {
              shouldSwitch = true;
              break;
            }
          }
        }

        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }
      }

      // Cambia el estado de ordenamiento después de ordenar la tabla
      toggleSortState(columnIndex);
    }
  </script>

</body>

</html>